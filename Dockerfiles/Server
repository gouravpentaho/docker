FROM openjdk:8-jre
MAINTAINER Gourav Mudgal

ARG INSTALLER=pdi-ee-client
ARG INSTALL_PATH=/home/devuser/pentaho/
ARG PLUGIN_INSTALL_PATH=/home/devuser/pentaho/pentaho-server/pentaho-solutions/system/

#ARG VERSION=9.2.0.0
#ARG DISTNO=290
#ARG PRODUCT=${INSTALLER}-${VERSION}-${DISTNO}
#ARG PRODUCT_ZIP=${PRODUCT}-dist.zip

# Install wget, unzip & sudo
RUN apt-get update && apt-get install wget unzip sudo -y

# Create devuser and add to sudoers
RUN useradd -m -s /bin/bash devuser
RUN echo 'devuser:pentaho06' | chpasswd
RUN usermod -aG sudo devuser

RUN mkdir -p /opt/installer \
    mkdir -p /home/devuser/pentaho

WORKDIR /opt/installer/

# Download Pentaho server and plug-ins installers, unzip them and delete zip files
RUN wget http://build.pentaho.net/hosted/9.2.0.0/290/pentaho-server-ee-9.2.0.0-290-dist.zip \
    && unzip -q pentaho-server-ee-9.2.0.0-290-dist.zip \
    && rm -f pentaho-server-ee-9.2.0.0-290-dist.zip

RUN wget http://build.pentaho.net/hosted/9.2.0.0/290/pir-plugin-ee-9.2.0.0-290-dist.zip \
    && unzip -q pir-plugin-ee-9.2.0.0-290-dist.zip \
    && rm -f pir-plugin-ee-9.2.0.0-290-dist.zip

RUN wget http://build.pentaho.net/hosted/9.2.0.0/290/paz-plugin-ee-9.2.0.0-290-dist.zip \
    && unzip -q paz-plugin-ee-9.2.0.0-290-dist.zip \
    && rm -f paz-plugin-ee-9.2.0.0-290-dist.zip

RUN wget http://build.pentaho.net/hosted/9.2.0.0/290/pdd-plugin-ee-9.2.0.0-290-dist.zip \
    && unzip -q pdd-plugin-ee-9.2.0.0-290-dist.zip \
    && rm -f pdd-plugin-ee-9.2.0.0-290-dist.zip

RUN java -DINSTALL_PATH=${INSTALL_PATH} -DEULA_ACCEPT=true -jar pentaho-server-ee-9.2.0.0-290/installer.jar -options-system \
    && java -DINSTALL_PATH=${PLUGIN_INSTALL_PATH} -DEULA_ACCEPT=true -jar pir-plugin-ee-9.2.0.0-290/installer.jar -options-system \
    && java -DINSTALL_PATH=${PLUGIN_INSTALL_PATH} -DEULA_ACCEPT=true -jar paz-plugin-ee-9.2.0.0-290/installer.jar -options-system \
    && java -DINSTALL_PATH=${PLUGIN_INSTALL_PATH} -DEULA_ACCEPT=true -jar pdd-plugin-ee-9.2.0.0-290/installer.jar -options-system

RUN rm -rf pentaho-server-ee-9.2.0.0-290 \
    && rm -rf pir-plugin-ee-9.2.0.0-290 \
    && rm -rf paz-plugin-ee-9.2.0.0-290 \
    && rm -rf pdd-plugin-ee-9.2.0.0-290

RUN wget -r -nH --cut-dirs=2 --no-parent --reject="index.html*" http://build.pentaho.net/hosted/engops/licenses/ \
    && sh /home/devuser/pentaho/license-installer/install_license.sh install -q /opt/installer/licenses/*.lic

WORKDIR /home/devuser/pentaho/pentaho-server

CMD bash -C 'printf "\n" | ./start-pentaho.sh';'bash'